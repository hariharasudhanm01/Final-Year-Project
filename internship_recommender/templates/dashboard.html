{% extends "base.html" %}

{% block title %}Dashboard - TalentMatch{% endblock %}

{% block content %}
<div class="with-sidebar">
  <!-- Sidebar -->
  <div class="sidebar">
    <h2>Menu</h2>
    <nav>
      <ul>
        <li><a href="/dashboard" class="active"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
        <li><a href="/profile"><i class="fas fa-user"></i> Profile</a></li>
        <li><a href="/upload"><i class="fas fa-upload"></i> Upload Resume</a></li>
        <li><a href="/enhance-resume"><i class="fas fa-magic"></i> AI Resume Enhancer</a></li>
        <li><a href="/profile-builder"><i class="fas fa-id-card-alt"></i> Profile Builder (AI)</a></li>
        <li><a href="/apply"><i class="fas fa-file-alt"></i> Application Form</a></li>
        <li><a href="/recommendations"><i class="fas fa-briefcase"></i> Job Recommendations</a></li>
        <li><a href="/logout"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
      </ul>
    </nav>
  </div>

  <!-- Main content -->
  <div class="main-content">
    <div class="top-nav">
      <h1>TalentMatch</h1>
      <div style="display: flex; align-items: center; gap: 1rem;">
        <div class="user-avatar">
          {{ (user.full_name or user.username)[0]|upper if user else 'U' }}
        </div>

      </div>
    </div>


    <div class="content">
      <h1>Welcome, {{ user.full_name or user.username }}!</h1>

      <div class="grid">
        <!-- Profile card -->
        <div class="card">
          <h3><i class="fas fa-user-circle"></i> Profile Summary</h3>
          {% if profile %}
          <p><strong>Degree:</strong> {{ profile.degree or 'Not specified' }}</p>
          <p><strong>Study Year:</strong> {{ profile.study_year or 'Not specified' }}</p>
          <p><strong>Sector:</strong> {{ profile.sector or 'Not specified' }}</p>
          <p><strong>Stream:</strong> {{ profile.stream or 'Not specified' }}</p>
          {% if profile.skills %}
          <p><strong>Skills:</strong></p>
          <div style="display: flex; flex-wrap: wrap;">

            {% for skill in profile.skills.split(',') %}
            {{ skill.strip() }}{% if not loop.last %}, {% endif %}
            {% endfor %}
            </p>

          </div>
          {% endif %}
          {% else %}
          <p>Complete your profile to get personalized recommendations!</p>
          {% endif %}
          <a href="/profile" class="btn btn-secondary" style="margin-top: 1rem;">Edit Profile</a>
        </div>

        <!-- Quick Actions card -->
        <div class="card">
          <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
          <div style="display: flex; flex-direction: column; gap: 1rem;">
            <a href="/upload" class="btn">Upload Resume & Get Recommendations</a>
            <a href="/apply" class="btn">Fill Application Form</a>
          </div>
        </div>

        <!-- AI Resume Enhancement card (NEW) -->
        <div class="card"
          style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
          <h3 style="color: white;"><i class="fas fa-magic"></i> AI Resume Enhancement</h3>
          <p style="color: rgba(255,255,255,0.9); margin: 0.5rem 0;">
            ✨ Optimize your resume for any job using AI-powered suggestions
          </p>
          <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-top: 1rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <i class="fas fa-check-circle" style="color: #4ade80;"></i>
              <span style="font-size: 0.9rem;">Powered by Ollama LLM</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <i class="fas fa-check-circle" style="color: #4ade80;"></i>
              <span style="font-size: 0.9rem;">Preserves layout & formatting</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <i class="fas fa-check-circle" style="color: #4ade80;"></i>
              <span style="font-size: 0.9rem;">Improves ATS score</span>
            </div>
          </div>
          <a href="/enhance-resume" class="btn"
            style="margin-top: 1rem; background: white; color: #667eea; font-weight: bold;">
            <i class="fas fa-rocket"></i> Enhance My Resume Now
          </a>
        </div>
      </div>

      <!-- Enhancements History -->
      <div class="card">
        <h3><i class="fas fa-file-contract"></i> Recent Enhanced Resumes</h3>
        {% if enhancement_history %}
        <div style="overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="text-align: left; border-bottom: 2px solid #eee;">
                <th style="padding: 10px;">Date</th>
                <th style="padding: 10px;">Job</th>
                <th style="padding: 10px;">Score Impr.</th>
                <th style="padding: 10px;">Action</th>
              </tr>
            </thead>
            <tbody>
              {% for item in enhancement_history %}
              <tr style="border-bottom: 1px solid #f0f0f0;">
                <td style="padding: 10px;">{{ item.created_at | format_date }}</td>
                <td style="padding: 10px;">
                  <div style="max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"
                    title="{{ item.job_description }}">
                    Job Description #{{ item.id }}
                  </div>
                </td>
                <td style="padding: 10px;">
                  <span class="badge" style="background: #e6fffa; color: #2c7a7b;">
                    {{ "%.0f"|format(item.ats_score_before) }}% <i class="fas fa-arrow-right"
                      style="font-size:0.8em"></i> {{ "%.0f"|format(item.ats_score_after if item.ats_score_after else
                    item.ats_score_before + 5) }}%
                  </span>
                </td>
                <td style="padding: 10px;">
                  <a href="{{ url_for('serve_resume', filename=item.modified_resume_path|basename) }}"
                    class="btn btn-sm btn-primary">
                    <i class="fas fa-download"></i> Download
                  </a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <p>No resumes enhanced yet. Try the AI Enhancer!</p>
        {% endif %}
      </div>

      <!-- Recommendations -->
      <div class="card">
        <h3><i class="fas fa-history"></i> Recent Recommendations</h3>
        {% if history %}
        {% for rec in history %}
        <div
          style="border-left: 3px solid var(--primary); padding-left: 1rem; margin: 1rem 0; background: var(--accent); border-radius: var(--border-radius);">
          <p><strong>{{ rec.role }}</strong> in {{ rec.location or 'Any location' }}</p>
          <p><small>Salary: ₹{{ rec.salary_range_low|lpa }} LPA - ₹{{ rec.salary_range_high|lpa }} LPA | {{
              rec.created_at }}</small></p>
        </div>
        {% endfor %}
        {% else %}
        <p>No recommendations yet. Get started by uploading your resume or filling the application form!</p>
        {% endif %}
      </div>


      <!-- ATS Educator Chat Widget -->
      <div id="ats-chat-widget" class="chat-widget" style="display: none;">
        <div class="chat-header">
          <div style="display: flex; align-items: center; gap: 10px;">
            <div class="chat-avatar"><i class="fas fa-robot"></i></div>
            <div>
              <h4 style="margin: 0; font-size: 1rem;">ATS Expert</h4>
              <span style="font-size: 0.75rem; opacity: 0.8;">Online • AI Powered</span>
            </div>
          </div>
          <button onclick="toggleChat()" class="close-chat"><i class="fas fa-times"></i></button>
        </div>
        <div class="chat-body" id="chat-messages">
          <div class="message bot">
            <div class="message-content">
              Hello! I'm your ATS & TalentMatch Expert. Ask me about:
              <br>• How to use this portal & upload resumes
              <br>• How the AI Enhancer & Analysis works
              <br>• How ATS systems score your resume
              <br>• Why resumes get rejected
            </div>
          </div>
        </div>
        <div class="chat-input-area">
          <input type="text" id="chat-input" placeholder="Ask about ATS, keywords, scoring..."
            onkeypress="handleEnter(event)">
          <button onclick="sendMessage()" class="send-btn"><i class="fas fa-paper-plane"></i></button>
        </div>
      </div>

      <!-- Floating Action Button -->
      <button class="fab-chat" onclick="toggleChat()" title="Chat with ATS Expert">
        <i class="fas fa-comments"></i>
      </button>

      <style>
        /* Chat Widget Styles */
        .fab-chat {
          position: fixed;
          bottom: 30px;
          right: 30px;
          width: 60px;
          height: 60px;
          border-radius: 50%;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          border: none;
          box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
          font-size: 24px;
          cursor: pointer;
          transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
          z-index: 1000;
          display: flex;
          align-items: center;
          justify-content: center;
        }

        .fab-chat:hover {
          transform: scale(1.1);
        }

        .chat-widget {
          position: fixed;
          bottom: 100px;
          right: 30px;
          width: 380px;
          height: 500px;
          background: white;
          border-radius: 20px;
          box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
          display: flex;
          flex-direction: column;
          overflow: hidden;
          z-index: 1000;
          animation: slideUp 0.3s ease-out;
          border: 1px solid rgba(0, 0, 0, 0.05);
        }

        @keyframes slideUp {
          from {
            opacity: 0;
            transform: translateY(20px);
          }

          to {
            opacity: 1;
            transform: translateY(0);
          }
        }

        .chat-header {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 15px 20px;
          display: flex;
          justify-content: space-between;
          align-items: center;
        }

        .chat-avatar {
          width: 35px;
          height: 35px;
          background: rgba(255, 255, 255, 0.2);
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
        }

        .close-chat {
          background: none;
          border: none;
          color: white;
          font-size: 1.2rem;
          cursor: pointer;
          opacity: 0.8;
          transition: opacity 0.2s;
        }

        .close-chat:hover {
          opacity: 1;
        }

        .chat-body {
          flex: 1;
          padding: 20px;
          overflow-y: auto;
          background: #f9f9f9;
          display: flex;
          flex-direction: column;
          gap: 15px;
        }

        .message {
          display: flex;
          flex-direction: column;
          max-width: 85%;
        }

        .message.bot {
          align-self: flex-start;
        }

        .message.user {
          align-self: flex-end;
        }

        .message-content {
          padding: 12px 16px;
          border-radius: 15px;
          font-size: 0.95rem;
          line-height: 1.5;
          position: relative;
        }

        .message.bot .message-content {
          background: white;
          border-bottom-left-radius: 2px;
          box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
          color: #333;
        }

        .message.user .message-content {
          background: #667eea;
          color: white;
          border-bottom-right-radius: 2px;
          box-shadow: 0 2px 5px rgba(102, 126, 234, 0.3);
        }

        .chat-input-area {
          padding: 15px;
          background: white;
          border-top: 1px solid #eee;
          display: flex;
          gap: 10px;
        }

        #chat-input {
          flex: 1;
          padding: 12px 15px;
          border: 1px solid #e0e0e0;
          border-radius: 25px;
          outline: none;
          font-size: 0.95rem;
          transition: border-color 0.2s;
        }

        #chat-input:focus {
          border-color: #667eea;
        }

        .send-btn {
          width: 45px;
          height: 45px;
          border-radius: 50%;
          background: #667eea;
          color: white;
          border: none;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: transform 0.2s;
        }

        .send-btn:hover {
          transform: scale(1.05);
        }

        /* Citation/Source styles */
        .sources-container {
          margin-top: 8px;
          font-size: 0.8rem;
          background: #f0f4ff;
          padding: 8px;
          border-radius: 8px;
          border-left: 3px solid #667eea;
        }

        .source-item {
          margin-bottom: 4px;
        }

        .source-item:last-child {
          margin-bottom: 0;
        }

        .source-title {
          font-weight: 600;
          color: #555;
        }
      </style>

      <script>
        function toggleChat() {
          const widget = document.getElementById('ats-chat-widget');
          if (widget.style.display === 'none') {
            widget.style.display = 'flex';
            setTimeout(() => document.getElementById('chat-input').focus(), 100);
          } else {
            widget.style.display = 'none';
          }
        }

        function handleEnter(e) {
          if (e.key === 'Enter') {
            sendMessage();
          }
        }

        function formatMessage(text) {
          // Specify which characters need to be escaped
          // Only implementing basic escaping for simplicity
          return text.replace(/\n/g, '<br>');
        }

        async function sendMessage() {
          const input = document.getElementById('chat-input');
          const message = input.value.trim();

          if (!message) return;

          // Add user message
          addMessage(message, 'user');
          input.value = '';

          // Add loading indicator
          const loadingId = addLoadingIndicator();

          try {
            const response = await fetch('/api/ats-educator/chat', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ question: message })
            });

            const data = await response.json();

            // Remove loading indicator
            removeMessage(loadingId);

            // Add bot response
            addMessage(data.answer, 'bot', data.sources);

          } catch (error) {
            removeMessage(loadingId);
            addMessage("Sorry, I encountered an error connecting to the ATS Expert. Please try again.", 'bot');
            console.error(error);
          }
        }

        function addLoadingIndicator() {
          const id = 'msg-' + Date.now();
          const messagesDiv = document.getElementById('chat-messages');

          const msgDiv = document.createElement('div');
          msgDiv.id = id;
          msgDiv.className = 'message bot';
          msgDiv.innerHTML = `
            <div class="message-content">
              <div style="display: flex; gap: 5px;">
                <span class="dot" style="animation: bounce 1.4s infinite 0s;">.</span>
                <span class="dot" style="animation: bounce 1.4s infinite 0.2s;">.</span>
                <span class="dot" style="animation: bounce 1.4s infinite 0.4s;">.</span>
              </div>
            </div>
          `;

          messagesDiv.appendChild(msgDiv);
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
          return id;
        }

        function removeMessage(id) {
          const msg = document.getElementById(id);
          if (msg) msg.remove();
        }

        function addMessage(text, type, sources = null) {
          const messagesDiv = document.getElementById('chat-messages');

          const msgDiv = document.createElement('div');
          msgDiv.className = `message ${type}`;

          let content = `<div class="message-content">${formatMessage(text)}`;

          if (sources && sources.length > 0) {
            content += `<div class="sources-container">`;
            content += `<div style="font-weight:bold; margin-bottom:4px;">Sources:</div>`;
            sources.forEach(source => {
              content += `<div class="source-item">
                <span class="source-title">${source.type.replace('_', ' ').toUpperCase()}:</span> 
                ${source.content.substring(0, 100)}...
              </div>`;
            });
            content += `</div>`;
          }

          content += `</div>`;
          msgDiv.innerHTML = content;

          messagesDiv.appendChild(msgDiv);
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
      </script>

      <style>
        @keyframes bounce {

          0%,
          80%,
          100% {
            transform: scale(0);
          }

          40% {
            transform: scale(1);
          }
        }

        .dot {
          font-size: 20px;
          color: #667eea;
          display: inline-block;
          margin-top: -10px;
        }
      </style>
    </div>
  </div>
</div>
{% endblock %}
{% extends "base.html" %}

{% block title %}Candidate Profile - HR Portal{% endblock %}

{% block content %}
<div class="with-sidebar">
  <div class="sidebar">
    <h2>HR Portal</h2>
    <nav>
      <ul>
        <li><a href="/hr/dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
        <li><a href="/hr/candidates"><i class="fas fa-users"></i> Candidates</a></li>
        <li><a href="/hr/jobs"><i class="fas fa-briefcase"></i> Job Postings</a></li>
        <li><a href="#" onclick="toggleChatbot(); return false;"><i class="fas fa-comments"></i> AI Assistant</a></li>
        <li><a href="/logout"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
      </ul>
    </nav>
  </div>

  <div class="main-content">
    <div class="top-nav">
      <h1>Candidate Profile</h1>
      <div style="display: flex; align-items: center; gap: 1rem;">
        <a href="/hr/candidates" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Back</a>
        <div class="user-avatar">
          {{ (user.full_name or user.username)[0]|upper if user else 'H' }}
        </div>
      </div>
    </div>
    
    <div class="content">
      <div class="card" style="margin-bottom: 2rem;">
        <h2 style="margin-top: 0; color: var(--primary);">
          <i class="fas fa-user-circle"></i> {{ candidate.full_name or candidate.username }}
        </h2>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-top: 1.5rem;">
          <div>
            <p><strong><i class="fas fa-envelope"></i> Email:</strong><br>{{ candidate.email }}</p>
          </div>
          {% if candidate.degree %}
          <div>
            <p><strong><i class="fas fa-graduation-cap"></i> Degree:</strong><br>{{ candidate.degree }}</p>
          </div>
          {% endif %}
          {% if candidate.study_year %}
          <div>
            <p><strong><i class="fas fa-calendar-alt"></i> Study Year:</strong><br>Year {{ candidate.study_year }}</p>
          </div>
          {% endif %}
          {% if candidate.stream %}
          <div>
            <p><strong><i class="fas fa-book"></i> Stream:</strong><br>{{ candidate.stream }}</p>
          </div>
          {% endif %}
          {% if candidate.sector %}
          <div>
            <p><strong><i class="fas fa-building"></i> Sector:</strong><br>{{ candidate.sector }}</p>
          </div>
          {% endif %}
          <div>
            <p><strong><i class="fas fa-calendar"></i> Joined:</strong><br>{{ candidate.created_at[:10] if candidate.created_at else 'N/A' }}</p>
          </div>
        </div>
      </div>

      {% if candidate.skills %}
      <div class="card" style="margin-bottom: 2rem;">
        <h3><i class="fas fa-tools"></i> Skills</h3>
        <div style="display: flex; flex-wrap: wrap; gap: 0.75rem; margin-top: 1rem;">
          {% for skill in candidate.skills.split(',') %}
            <span style="background: var(--primary); color: white; padding: 0.5rem 1rem; border-radius: 25px; font-size: 0.95rem; font-weight: 500;">{{ skill.strip() }}</span>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      {% if candidate.resume_path %}
      <div class="card" style="margin-bottom: 2rem;">
        <h3><i class="fas fa-file-pdf"></i> Resume</h3>
        {% set resume_filename = candidate.resume_path.split('/')[-1] if '/' in candidate.resume_path else candidate.resume_path.split('\\')[-1] %}
        <a href="/uploads/{{ resume_filename }}" target="_blank" class="btn">
          <i class="fas fa-download"></i> Download Resume
        </a>
        <p style="margin-top: 0.5rem; color: #666; font-size: 0.9rem;">
          <i class="fas fa-info-circle"></i> File: {{ resume_filename }}
        </p>
      </div>
      {% endif %}

      {% if history %}
      <div class="card">
        <h3><i class="fas fa-history"></i> Recommendation History</h3>
        <div style="display: grid; gap: 1rem; margin-top: 1rem;">
          {% for rec in history %}
          <div style="border-left: 3px solid var(--primary); padding: 1rem; background: var(--accent); border-radius: var(--border-radius);">
            <p style="margin: 0.5rem 0;"><strong>{{ rec.role }}</strong></p>
            {% if rec.location %}
            <p style="margin: 0.5rem 0; color: #666;"><i class="fas fa-map-marker-alt"></i> {{ rec.location }}</p>
            {% endif %}
            {% if rec.salary_range_low and rec.salary_range_high %}
            <p style="margin: 0.5rem 0; color: #666;">
              <i class="fas fa-rupee-sign"></i> Salary: ₹{{ rec.salary_range_low|int / 100000 }} LPA - ₹{{ rec.salary_range_high|int / 100000 }} LPA
            </p>
            {% endif %}
            {% if rec.skills_used %}
            <p style="margin: 0.5rem 0;">
              <strong>Skills Used:</strong> 
              {% for skill in rec.skills_used.split(',')[:5] %}
                <span style="background: #667eea; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.85rem; display: inline-block; margin: 0.25rem 0.25rem 0.25rem 0;">{{ skill.strip() }}</span>
              {% endfor %}
            </p>
            {% endif %}
            <p style="margin: 0.5rem 0 0 0; color: #999; font-size: 0.9rem;">{{ rec.created_at[:16] if rec.created_at else '' }}</p>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<style>
  .card {
    background: white;
    border-radius: var(--border-radius);
    padding: 1.5rem;
    box-shadow: 0 2px 10px var(--shadow);
  }

  /* Chatbot Styles - Same as dashboard */
  #chatbot-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 400px;
    max-height: 600px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    display: none;
    flex-direction: column;
    z-index: 1000;
    overflow: hidden;
  }

  #chatbot-container.open {
    display: flex;
  }

  .chatbot-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1rem 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .chatbot-header h3 {
    margin: 0;
    font-size: 1.1rem;
  }

  .chatbot-close {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 1.2rem;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .chatbot-close:hover {
    background: rgba(255, 255, 255, 0.3);
  }

  .chatbot-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    max-height: 400px;
  }

  .chatbot-message {
    padding: 0.75rem 1rem;
    border-radius: 12px;
    max-width: 80%;
    word-wrap: break-word;
  }

  .chatbot-message.user {
    background: #667eea;
    color: white;
    align-self: flex-end;
    margin-left: auto;
  }

  .chatbot-message.assistant {
    background: #f0f0f0;
    color: #333;
    align-self: flex-start;
  }

  .chatbot-input-area {
    padding: 1rem;
    border-top: 1px solid #e0e0e0;
    display: flex;
    gap: 0.5rem;
  }

  .chatbot-input {
    flex: 1;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 0.9rem;
  }

  .chatbot-send {
    padding: 0.75rem 1.5rem;
    background: #667eea;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
  }

  .chatbot-send:hover {
    background: #5568d3;
  }

  .chatbot-send:disabled {
    background: #ccc;
    cursor: not-allowed;
  }

  .chatbot-suggestions {
    padding: 0.5rem 1rem;
    border-top: 1px solid #e0e0e0;
    max-height: 150px;
    overflow-y: auto;
  }

  .chatbot-suggestion {
    display: block;
    width: 100%;
    padding: 0.5rem;
    margin: 0.25rem 0;
    background: #f8f9fa;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
    text-align: left;
    color: #667eea;
  }

  .chatbot-suggestion:hover {
    background: #e9ecef;
  }

  .chatbot-loading {
    display: none;
    padding: 0.5rem;
    text-align: center;
    color: #666;
    font-size: 0.85rem;
  }

  .chatbot-loading.show {
    display: block;
  }

  .chatbot-status {
    padding: 0.5rem 1rem;
    font-size: 0.8rem;
    color: #666;
    background: #f8f9fa;
    border-top: 1px solid #e0e0e0;
  }

  .chatbot-status.error {
    color: #dc3545;
    background: #f8d7da;
  }

  .chatbot-status.success {
    color: #28a745;
    background: #d4edda;
  }
</style>

<!-- HR Chatbot Widget -->
<div id="chatbot-container">
  <div class="chatbot-header">
    <h3><i class="fas fa-robot"></i> AI Candidate Assistant</h3>
    <button class="chatbot-close" onclick="toggleChatbot()">×</button>
  </div>
  
  <div class="chatbot-status" id="chatbot-status">
    <i class="fas fa-circle" style="color: #28a745; font-size: 0.6rem;"></i> Ready to help
  </div>

  <div class="chatbot-messages" id="chatbot-messages">
    <div class="chatbot-message assistant">
      <strong>AI Assistant:</strong> I'm analyzing <strong>{{ candidate.full_name or candidate.username }}</strong>. Ask me about their profile, skills, resume, or match scores!
    </div>
  </div>

  <div class="chatbot-suggestions" id="chatbot-suggestions">
    <!-- Suggestions will be loaded here -->
  </div>

  <div class="chatbot-loading" id="chatbot-loading">
    <i class="fas fa-spinner fa-spin"></i> Thinking...
  </div>

  <div class="chatbot-input-area">
    <input type="text" class="chatbot-input" id="chatbot-input" 
           placeholder="Ask about this candidate..." 
           onkeypress="if(event.key==='Enter') sendChatbotMessage()">
    <button class="chatbot-send" onclick="sendChatbotMessage()" id="chatbot-send">
      <i class="fas fa-paper-plane"></i>
    </button>
  </div>
</div>

<script>
let chatbotHistory = [];
let currentCandidateId = {{ candidate.id }};
let currentJobId = null;

function toggleChatbot() {
  const container = document.getElementById('chatbot-container');
  container.classList.toggle('open');
  
  if (container.classList.contains('open')) {
    loadSuggestions();
    document.getElementById('chatbot-input').focus();
  }
}

function loadSuggestions() {
  const suggestionsDiv = document.getElementById('chatbot-suggestions');
  const params = new URLSearchParams();
  if (currentCandidateId) params.append('candidate_id', currentCandidateId);
  if (currentJobId) params.append('job_id', currentJobId);
  
  fetch(`/api/hr/chatbot/suggestions?${params}`)
    .then(response => response.json())
    .then(data => {
      suggestionsDiv.innerHTML = '';
      data.suggestions.forEach(suggestion => {
        const btn = document.createElement('button');
        btn.className = 'chatbot-suggestion';
        btn.textContent = suggestion;
        btn.onclick = () => {
          document.getElementById('chatbot-input').value = suggestion;
          sendChatbotMessage();
        };
        suggestionsDiv.appendChild(btn);
      });
    })
    .catch(error => {
      console.error('Error loading suggestions:', error);
    });
}

function sendChatbotMessage() {
  const input = document.getElementById('chatbot-input');
  const question = input.value.trim();
  
  if (!question) return;
  
  addMessage('user', question);
  input.value = '';
  
  const sendBtn = document.getElementById('chatbot-send');
  const inputField = document.getElementById('chatbot-input');
  sendBtn.disabled = true;
  inputField.disabled = true;
  document.getElementById('chatbot-loading').classList.add('show');
  
  const payload = {
    question: question,
    candidate_id: currentCandidateId,
    job_id: currentJobId,
    history: chatbotHistory
  };
  
  fetch('/api/hr/chatbot', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(payload)
  })
  .then(response => response.json())
  .then(data => {
    document.getElementById('chatbot-loading').classList.remove('show');
    
    if (data.status === 'success') {
      addMessage('assistant', data.response);
      updateStatus('success', 'Response received');
      
      chatbotHistory.push({ role: 'user', content: question });
      chatbotHistory.push({ role: 'assistant', content: data.response });
      
      if (chatbotHistory.length > 10) {
        chatbotHistory = chatbotHistory.slice(-10);
      }
    } else {
      addMessage('assistant', `Error: ${data.response || data.error || 'Unknown error'}`);
      updateStatus('error', 'Error occurred');
    }
  })
  .catch(error => {
    document.getElementById('chatbot-loading').classList.remove('show');
    addMessage('assistant', `Sorry, I encountered an error: ${error.message}`);
    updateStatus('error', 'Connection error');
  })
  .finally(() => {
    sendBtn.disabled = false;
    inputField.disabled = false;
    inputField.focus();
  });
}

function addMessage(role, content) {
  const messagesDiv = document.getElementById('chatbot-messages');
  const messageDiv = document.createElement('div');
  messageDiv.className = `chatbot-message ${role}`;
  
  if (role === 'assistant') {
    messageDiv.innerHTML = `<strong>AI Assistant:</strong> ${content}`;
  } else {
    messageDiv.textContent = content;
  }
  
  messagesDiv.appendChild(messageDiv);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function updateStatus(type, message) {
  const statusDiv = document.getElementById('chatbot-status');
  statusDiv.className = `chatbot-status ${type}`;
  statusDiv.innerHTML = `<i class="fas fa-circle" style="color: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#666'}; font-size: 0.6rem;"></i> ${message}`;
  
  setTimeout(() => {
    statusDiv.className = 'chatbot-status';
    statusDiv.innerHTML = '<i class="fas fa-circle" style="color: #28a745; font-size: 0.6rem;"></i> Ready to help';
  }, 3000);
}

// Load suggestions on page load
document.addEventListener('DOMContentLoaded', function() {
  loadSuggestions();
});
</script>
{% endblock %}

